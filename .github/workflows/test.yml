# This workflow will install Python dependencies and run tests on
# windows and linux systems with a variety of Python versions

name: tests

on:
    push:
    pull_request:
    workflow_dispatch:
    schedule: # only upstream, won't trigger on forks!
        - cron: '0 0 * * *' # daily

jobs:
    linux-tests:
        name: Build py${{ matrix.python-version }} @ ${{ matrix.os }} 🐍
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                python-version: ['3.8', '3.9', '3.10']
                os: ['ubuntu-latest']
                ymlfile: ['environment.yml']
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - uses: mamba-org/setup-micromamba@v1
              with:
                  micromamba-version: 'latest'
                  environment-file: ${{ matrix.ymlfile }} # Ensure the env file is correctly defined
                  micromamba-root-path: ~/micromamba # Optional, where to install micromamba

            - name: Initialize micromamba environment
              shell: bash -l {0}
              run: |
                  micromamba shell init -s bash -p ~/micromamba/envs/qa4sm_reader
                  echo "source ~/micromamba/etc/profile.d/micromamba.sh" >> ~/.bashrc

            - name: Create and activate environment
              shell: bash -l {0}
              run: |
                  source ~/micromamba/etc/profile.d/micromamba.sh
                  micromamba create -y --name qa4sm_reader --file ${{ matrix.ymlfile }}
                  micromamba activate qa4sm_reader

            - name: Print environment infos
              shell: bash -l {0}
              run: |
                  micromamba info
                  micromamba list
                  pip list
                  which pip
                  which python

            - name: Export Environment
              shell: bash -l {0}
              run: |
                  mkdir -p artifacts
                  filename=env_py${{ matrix.python-version }}_${{ matrix.os }}.yml
                  micromamba env export --name qa4sm_reader > artifacts/$filename

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Artifacts-py${{ matrix.python-version }}-${{ matrix.os }}
                  path: artifacts/*

            - name: Install package and test
              shell: bash -l {0}
              run: |
                  pip install -e .
                  pytest

            - name: Upload Coverage
              shell: bash -l {0}
              run: |
                  pip install coveralls && coveralls --service=github
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  COVERALLS_FLAG_NAME: ${{ matrix.python-version }}
                  COVERALLS_PARALLEL: true

    windows-tests:
        name: Build py${{ matrix.python-version }} @ ${{ matrix.os }} 🐍
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                python-version: ['3.10']
                os: ['windows-latest']
                ymlfile: ['environment.yml']
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - name: Install Micromamba
              shell: cmd
              run: |
                  curl -Ls https://micromamba.snakepit.net/api/micromamba/win-64/latest | tar -xvj -C C:\micromamba\bin
                  set PATH=C:\micromamba\bin;%PATH%
                  micromamba --version

            - uses: mamba-org/setup-micromamba@v1
              with:
                  micromamba-version: 'latest'
                  environment-file: ${{ matrix.ymlfile }}
                  micromamba-root-path: C:\micromamba

            - name: Initialize micromamba environment
              shell: cmd
              run: |
                  micromamba shell init -s cmd -p C:\micromamba\envs\qa4sm_reader

            - name: Create and activate environment
              shell: cmd
              run: |
                  call C:\micromamba\etc\profile.d\micromamba.cmd
                  micromamba create -y --name qa4sm_reader --file C:\micromamba\envs\qa4sm_reader\${{ matrix.ymlfile }}
                  micromamba activate qa4sm_reader

            - name: Print environment infos
              shell: cmd
              run: |
                  micromamba info
                  micromamba list
                  pip list
                  where pip
                  where python

            - name: Export Environment
              shell: cmd
              run: |
                  mkdir artifacts
                  set filename=env_py${{ matrix.python-version }}_${{ matrix.os }}.yml
                  micromamba env export --name qa4sm_reader > artifacts\%filename%

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Artifacts-py${{ matrix.python-version }}-${{ matrix.os }}
                  path: artifacts\*

            - name: Install package and test
              shell: cmd
              run: |
                  pip install -e .
                  pytest

            - name: Upload Coverage
              shell: cmd
              run: |
                  pip install coveralls && coveralls --service=github
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  COVERALLS_FLAG_NAME: ${{ matrix.python-version }}
                  COVERALLS_PARALLEL: true

    coveralls:
        name: Submit Coveralls 👚
        needs: [linux-tests, windows-tests]
        runs-on: ubuntu-latest
        container: python:3-slim
        steps:
            - name: Finished
              run: |
                  pip3 install --upgrade coveralls && coveralls --service=github --finish
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
