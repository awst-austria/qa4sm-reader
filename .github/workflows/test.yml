# This workflow will install Python dependencies and run tests on
# Windows and Linux systems with a variety of Python versions

name: tests

on:
    push:
    pull_request:
    workflow_dispatch:
    schedule: # only upstream, won't trigger on forks!
        - cron: '0 0 * * *' # daily

jobs:
    build:
        name: Build py${{ matrix.python-version }} @ ${{ matrix.os }} 🐍
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                python-version: ['3.8', '3.9', '3.10']
                os: ['ubuntu-latest']
                ymlfile: ['environment.yml']
                include:
                    - os: 'windows-latest'
                      python-version: '3.10'
                      ymlfile: 'environment.yml'

        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true

            - uses: mamba-org/setup-micromamba@v1
              with:
                  micromamba-version: 'latest'
                  micromamba-root-path: ~/micromamba # Optional, where to install micromamba

            - name: Initialize micromamba environment (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  micromamba shell init -s bash -p ~/micromamba/envs/qa4sm_reader
                  micromamba create -y --name qa4sm_reader --file ${{ matrix.ymlfile }}
                  echo "source ~/micromamba/etc/profile.d/micromamba.sh" >> ~/.bashrc

            - name: Initialize micromamba environment (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  micromamba shell init -s cmd -p %USERPROFILE%\micromamba\envs\qa4sm_reader
                  micromamba create -y --name qa4sm_reader --file %USERPROFILE%\micromamba\envs\qa4sm_reader\${{ matrix.ymlfile }}

            - name: Activate environment (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  source ~/micromamba/etc/profile.d/micromamba.sh
                  micromamba activate qa4sm_reader

            - name: Activate environment (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  call %USERPROFILE%\micromamba\etc\profile.d\micromamba.cmd
                  micromamba activate qa4sm_reader

            - name: Print environment infos (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  micromamba info
                  micromamba list
                  pip list
                  which pip
                  which python

            - name: Print environment infos (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  micromamba info
                  micromamba list
                  pip list
                  where pip
                  where python

            - name: Export Environment (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  mkdir -p artifacts
                  filename=env_py${{ matrix.python-version }}_${{ matrix.os }}.yml
                  micromamba env export --name qa4sm_reader > artifacts/$filename

            - name: Export Environment (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  mkdir artifacts
                  set filename=env_py${{ matrix.python-version }}_${{ matrix.os }}.yml
                  micromamba env export --name qa4sm_reader > artifacts\%filename%

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Artifacts-py${{ matrix.python-version }}-${{ matrix.os }}
                  path: artifacts/*

            - name: Install package and test (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  pip install -e .
                  pytest

            - name: Install package and test (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  pip install -e .
                  pytest

            - name: Upload Coverage (Linux)
              if: runner.os == 'Linux'
              shell: bash -l {0}
              run: |
                  pip install coveralls && coveralls --service=github
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  COVERALLS_FLAG_NAME: ${{ matrix.python-version }}
                  COVERALLS_PARALLEL: true

            - name: Upload Coverage (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  pip install coveralls && coveralls --service=github
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  COVERALLS_FLAG_NAME: ${{ matrix.python-version }}
                  COVERALLS_PARALLEL: true

    coveralls:
        name: Submit Coveralls 👚
        needs: build
        runs-on: ubuntu-latest
        container: python:3-slim
        steps:
            - name: Finished
              run: |
                  pip3 install --upgrade coveralls && coveralls --service=github --finish
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
